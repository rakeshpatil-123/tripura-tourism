<div class="dialog-header" mat-dialog-title>
  <h2>{{ data.mode === 'add' ? 'Add Questionnaire' : 'Update Questionnaire' }}</h2>
  <button mat-icon-button (click)="close()">
    <mat-icon>close</mat-icon>
  </button>
</div>
<div class="service-info">
  <strong>Service Group:</strong> {{ data.service?.name || 'Unknown Service' }}
</div>

<mat-dialog-content>
  <form [formGroup]="questionnaireForm" class="form-container">

    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Question Label</mat-label>
        <input matInput formControlName="question_label" placeholder="Enter question label" />
        <mat-error *ngIf="questionnaireForm.get('question_label')?.hasError('required')">
          Question label is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Question Type</mat-label>
        <mat-select formControlName="question_type">
          <mat-option value="text">Text</mat-option>
          <mat-option value="number">Number</mat-option>
          <mat-option value="select">Dropdown</mat-option>
          <mat-option value="file">File</mat-option>
          <mat-option value="radio">Radio</mat-option>
          <mat-option value="checkbox">Checkbox</mat-option>
          <mat-option value="date">Date</mat-option>
          <!-- <mat-option value="date_mmdd">Date(mmdd)</mat-option> -->
          <!-- <mat-option value="date_yyyymmdd">Date(yyyymmdd)</mat-option> -->
          <!-- <mat-option value="button">Button</mat-option> -->
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Is Required?</mat-label>
        <mat-select formControlName="is_required">
          <mat-option value="yes">Yes</mat-option>
          <mat-option value="no">No</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="form-row">
      <mat-form-field appearance="outline"
        [style.flex]="questionnaireForm.get('is_section')?.value === 'yes' ? '1 1 auto' : '0 0 150px'">
        <mat-label>Is Section</mat-label>
        <mat-select formControlName="is_section">
          <mat-option value="yes">Yes</mat-option>
          <mat-option value="no">No</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="form-field" *ngIf="questionnaireForm.get('is_section')?.value === 'yes'"
        style="flex: 1 1 auto;">
        <mat-label>Select Section</mat-label>
        <mat-select formControlName="section_name">
          <mat-option>
            <ngx-mat-select-search placeholderLabel="Search sections..." (keyup)="filterSections($event)">
            </ngx-mat-select-search>
          </mat-option>
          <h3 class="panel-title">Available Sections</h3>
          <mat-option *ngFor="let section of filteredSections" [value]="section">
            <mat-icon class="custom-icon">view_list</mat-icon>
            <span>{{ section }}</span>
          </mat-option>
          
          <mat-divider></mat-divider>
          <ng-container *ngIf="!isAddingNewSection">
            <button mat-button class="add-new-btn" (click)="showAddNewSectionInput($event)">
              <mat-icon>add</mat-icon>
              Add New Section
            </button>
          </ng-container>
          <div *ngIf="isAddingNewSection" class="add-new-form">
            <input matInput placeholder="Enter new section" [(ngModel)]="newSectionName" [ngModelOptions]="{ standalone: true }"
              (keydown.space)="stopEvent($event)" (keydown)="stopEvent($event)" (keyup.enter)="onSaveNewSection($event)"
              class="new-section-input" />
            <button mat-icon-button color="primary" (click)="onSaveNewSection($event)">
              <mat-icon>save</mat-icon>
            </button>
          </div>
        </mat-select>
        <mat-icon matSuffix>category</mat-icon>
      </mat-form-field>
    </div>
    <div class="form-row" *ngIf="['select','radio','checkbox'].includes(questionnaireForm.get('question_type')?.value)">
      <mat-form-field appearance="outline" class="form-field full-width">
        <mat-label>Options (comma separated)</mat-label>
        <input matInput formControlName="options" placeholder="Eg: Option1, Option2, Option3" />
      </mat-form-field>
    </div>
    <div class="form-row" *ngIf="questionnaireForm.get('question_type')?.value === 'file'">
      <app-ilogi-file-upload [formControlName]="'sample_format'" [fileUrl]="getExistingFileUrl('sample_format')"
        accept=".png,.jpg,.jpeg,.pdf,.docx,.xls,.xlsx,.csv,.txt" label="Upload Template Format" (onRemove)="removeFile('sample_format')"
        (fileSelected)="onFileSelected($event, 'sample_format')">
      </app-ilogi-file-upload>
    </div>
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Default Value</mat-label>
        <input matInput formControlName="default_value" placeholder="Enter default value" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Source Table</mat-label>
        <mat-select formControlName="default_source_table" (selectionChange)="onTableChange($event.value)">
          <mat-option value="unit_details">Unit Details</mat-option>
          <mat-option value="enterprise_details">Enterprise Details</mat-option>
          <mat-option value="management_details">Management Details</mat-option>
          <mat-option value="line_of_activities">Line of Activity</mat-option>
          <mat-option value="general_attachments">General Attachments</mat-option>
          <mat-option value="clearances">Clearances</mat-option>
          <mat-option value="bank_details">Bank Details</mat-option>
          <mat-option value="activities">Activities</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Source Column</mat-label>
        <mat-select formControlName="default_source_column">
          <mat-option *ngFor="let col of availableColumns" [value]="col">{{ col }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Display Order</mat-label>
        <input matInput type="number" value="1" formControlName="display_order" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Group Label</mat-label>
        <input matInput placeholder="Basic Information" formControlName="group_label" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Display Width</mat-label>
        <mat-select formControlName="display_width">
          <mat-option value="25%">25%</mat-option>
          <mat-option value="50%">50%</mat-option>
          <mat-option value="100%">100%</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="form-row">
      <mat-form-field appearance="outline" class="form-field ">
        <mat-label>Is Validation Required</mat-label>
        <mat-select formControlName="validation_required">
          <mat-option value="yes">Yes</mat-option>
          <mat-option value="no">No</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status">
          <mat-option value="1">Active</mat-option>
          <mat-option value="0">Inactive</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="validation-section">
      <h3>Display Rule</h3>
      <div class="form-row validation-row">
        <mat-form-field appearance="outline">
          <mat-label>Condition Question</mat-label>
          <mat-select [compareWith]="compareQuestions" formControlName="depends_on">
            <mat-option [value]="null">(None)</mat-option>
            <mat-option *ngFor="let q of apiQuestions" [value]="q.id">
              {{ q.question_label || q.title || q.label || ('Q' + q.id) }}
            </mat-option>
            <mat-option *ngIf="!apiQuestions?.length" disabled>
              No questions available. Please add a question first.
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Condition Operator</mat-label>
          <mat-select formControlName="operator">
            <mat-option [value]="null">(None)</mat-option>
            <mat-option value="<">&lt;</mat-option>
            <mat-option value="<=">&lt;=</mat-option>
            <mat-option value=">">&gt;</mat-option>
            <mat-option value=">=">&gt;=</mat-option>
            <mat-option value="=">=</mat-option>
            <mat-option value="!=">!=</mat-option>
            <mat-option value="between">Between</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field *ngIf="questionnaireForm.get('question_type')?.value !== 'date_mmdd' && questionnaireForm.get('question_type')?.value !== 'date_yyyymmdd'" appearance="outline">
          <mat-label>Condition Value</mat-label>
          <input matInput formControlName="value"placeholder="Enter your Value" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Start Value</mat-label>
          <input matInput formControlName="start_value" placeholder="Enter your Value" />
        </mat-form-field>
        <mat-form-field *ngIf="questionnaireForm.get('question_type')?.value === 'date_dd_mm'" appearance="outline">
          <mat-label>End Value</mat-label>
          <input matInput formControlName="end_value" placeholder="Enter your Value" />
        </mat-form-field>
      </div>
    </div>
  <div formGroupName="validation_rule" class="validation-section">
    <h3>Validation Rule</h3>
      <div class="form-row upload-rule-section" *ngIf="questionnaireForm.get('question_type')?.value === 'file'">
      <h3 class="section-title">Upload Rules</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field full-width">
          <mat-label>Allowed File Types</mat-label>
          <mat-select formControlName="mimes" multiple>
            <mat-option *ngFor="let type of allowedFileTypes" [value]="type">{{ type }}</mat-option>
          </mat-select>
          <mat-hint align="start">Select multiple file types (e.g. pdf, jpg, png)</mat-hint>
          <mat-error *ngIf="validationRule.get('mimes')?.hasError('required')">
            Allowed file types are <b>required</b>.
          </mat-error>
        </mat-form-field>
      </div>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Maximum File Size (MB)</mat-label>
          <input matInput type="number" formControlName="max_size_mb" placeholder="e.g. 3" min="1" max="3" />
          <mat-hint align="start">Recommended: 1â€“3 MB</mat-hint>
          <mat-error *ngIf="validationRule.get('max_size_mb')?.hasError('required')">
            Max file size is <b>required</b>.
          </mat-error>
          <mat-error *ngIf="validationRule.get('max_size_mb')?.hasError('max')">
            File size cannot exceed <b>3 MB</b>.
          </mat-error>
          <mat-error *ngIf="validationRule.get('max_size_mb')?.hasError('min')">
            File size must be at least <b>1 MB</b>.
          </mat-error>
        </mat-form-field>
      </div>
    </div>
      <div class="form-row validation-row">
        <mat-form-field *ngIf="questionnaireForm.get('question_type')?.value !== 'file'" appearance="outline"
          class="form-field minmax-field">
          <mat-label>Min Length</mat-label>
          <input matInput type="number" formControlName="minLength" />
        </mat-form-field>

        <mat-form-field *ngIf="questionnaireForm.get('question_type')?.value !== 'file'" appearance="outline"
          class="form-field minmax-field">
          <mat-label>Max Length</mat-label>
          <input matInput type="number" formControlName="maxLength" />
        </mat-form-field>

        <mat-form-field *ngIf="questionnaireForm.get('question_type')?.value !== 'file'" appearance="outline"
          class="form-field pattern-field">
          <mat-label>Pattern</mat-label>
          <mat-select formControlName="pattern" placeholder="Select Pattern">
            <mat-option *ngFor="let item of regexPatterns" [value]="item.value">{{ item.label }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field *ngIf="questionnaireForm.get('question_type')?.value !== 'file'" appearance="outline"
          class="form-field error-field">
          <mat-label>Error Message</mat-label>
          <input matInput formControlName="errorMessage" placeholder="Only alphabets allowed" />
        </mat-form-field>
      </div>
    </div>
  </form>

  <div class="preview-section" *ngIf="apiQuestions.length">
    <h3>Questionnaires Preview</h3>
    <table mat-table [dataSource]="apiQuestions" class="mat-elevation-z2 preview-table full-width">

      <ng-container matColumnDef="question_label">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Question </th>
        <td mat-cell *matCellDef="let q"> {{q.question_label}} </td>
      </ng-container>

      <ng-container matColumnDef="question_type">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Type </th>
        <td mat-cell *matCellDef="let q"> {{q.question_type}} </td>
      </ng-container>

      <ng-container matColumnDef="options">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Options </th>
        <td mat-cell *matCellDef="let q"> {{ getOptionsAsString(q) || '-' }} </td>
      </ng-container>

      <ng-container matColumnDef="default_value">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Default </th>
        <td mat-cell *matCellDef="let q"> {{q.default_value || '-'}} </td>
      </ng-container>

      <ng-container matColumnDef="is_required">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Required </th>
        <td mat-cell *matCellDef="let q"> {{q.is_required}} </td>
      </ng-container>

      <ng-container matColumnDef="display_order">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Order </th>
        <td mat-cell *matCellDef="let q"> {{q.display_order}} </td>
      </ng-container>

      <ng-container matColumnDef="group_label">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Group </th>
        <td mat-cell *matCellDef="let q"> {{q.group_label}} </td>
      </ng-container>

      <ng-container matColumnDef="display_width">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Width </th>
        <td mat-cell *matCellDef="let q"> {{q.display_width}} </td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef class="header-class"> Status </th>
        <td mat-cell *matCellDef="let q"> {{q.status}} </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

    </table>
  </div>

</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button color="warn" (click)="close()">Cancel</button>
  <button mat-flat-button color="accent" class="submit-btn" (click)="submit()">
    {{ data.mode === 'add' ? 'Save' : 'Update' }}
  </button>
</mat-dialog-actions>