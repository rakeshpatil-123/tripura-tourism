<div class="service-view-container">
  <!-- <h2 class="page-head mb-3">Application Details</h2> -->

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading application details...</p>
  </div>

  <div *ngIf="!isLoading && !applicationData" class="text-center text-muted py-5">
    <p> Application not found.</p>

  </div>

  <div *ngIf="!isLoading && applicationData">

    <!-- Workflow History -->
    <div *ngIf="workflowData.length > 0" class="btn-right">
      <h3 class=" page-head">Workflow Steps</h3>

      <div class="btn-group-right">
        <button class="btn btn-primary" *ngIf="isFinalApproval"
          mat-raised-button class="generate-btn" (click)="editCertificateGeneration()">
          <mat-icon style="color: white;" class="mr-2">workspace_premium</mat-icon>
          <span style="color: white;">Generate Certificate</span>
        </button>
         <button class="btn btn-primary" *ngIf="isFinalApproval"
            mat-raised-button color="primary" (click)="previewCertificate()">
            <span style="color: white;">Preview Certificate</span>
          </button>
        <button (click)="navigateToCAF()" class="btn btn-success">CAF <mat-icon>visibility</mat-icon></button>
        <button (click)="editCertificateGeneration()" *ngIf="isFinalApproval" class="submit-btn">Certificate
          <mat-icon>picture_as_pdf</mat-icon>
        </button>
        <button mat-raised-button color="primary" class="submit-btn" *ngIf="sampleFilePreview" (click)="previewSampleFile()">
          Preview Sample File
        </button>
      </div>
    </div>
    <app-dynamic-table [data]="workflowData" [columns]="workflowColumns" [showPagination]="true" [pageSize]="5"
      [searchable]="true"></app-dynamic-table>

    <ng-container *ngIf="applicationQAColumns.length > 0; else noQa">
      <h3 class="mt-4 page-head">Application Questions & Answers</h3>
      <div class="qa-section">
        <ng-container *ngFor="let item of applicationQATableData; let i = index">
          <div *ngIf="item.isSection" class="qa-section-header">
            <h5 class="section-title">{{ item.question }}</h5>
          </div>
          <div *ngIf="!item.isSection" class="qa-item">
            <div class="qa-question">{{ item.question }}</div>
            <div class="qa-answer" *ngIf="item.isFile">
              <button type="button" class="view-file-btn" (click)="openFile(item.fileUrl)">{{ item.fileName }}</button>
            </div>
            <div class="qa-answer" *ngIf="!item.isFile">{{ item.answer }}</div>
          </div>
        </ng-container>
      </div>
    </ng-container>
    <ng-template #noQa>
      <div class="alert alert-info mt-4">
        No application questions provided.
      </div>
    </ng-template>

    <!-- Main Application Summary -->
    <div *ngIf="infoData.length > 0">
      <h3 class="mt-4 page-head">Application Summary</h3>
      <app-dynamic-table [data]="infoData" [columns]="infoColumns" [showPagination]="false"
        [searchable]="false"></app-dynamic-table>
    </div>


  </div>

  <!-- Status Action Modal -->
  <div *ngIf="statusModal.visible" class="modal-overlay">
    <div class="modal-content">
      <h3>{{ statusModal.title }}</h3>

      <form [formGroup]="remarkForm" (ngSubmit)="onSubmitStatus()">
        <div class="extra-payment" *ngIf="statusModal.action === 'raise_extra_payment'">
          <app-ilogi-input formControlName="extraAmount" fieldLabel="Extra Payment Amount" [mandatory]="true"
            placeholder="Enter extra payment amount" [type]="'number'" inputType="number"></app-ilogi-input>

          <small *ngIf="remarkForm.get('extraAmount')?.invalid && remarkForm.get('extraAmount')?.touched" class="text-danger">Extra Payment Amount is required.</small>
        </div>
        <div class="mb-3">
          <app-ilogi-input formControlName="remarks" label="Remarks" [mandatory]="true"
            placeholder="Enter remarks for this action (min 2 characters)"></app-ilogi-input>
        </div>
        <div>
          <app-ilogi-file-upload formControlName="attachment" [mandatory]="false"
            placeholder="Upload supporting document" accept=".png,.jpg,.jpeg,.pdf"></app-ilogi-file-upload>
        </div>

        <small *ngIf="remarkForm.get('remarks')?.invalid && remarkForm.get('remarks')?.touched" class="text-danger">
          Remarks are required and must be at least 2 characters.
        </small>
        <div class="modal-actions">
         
<!-- 
          <button class="btn btn-primary" *ngIf="isCertificatePreview && statusModal.action === 'approved'"
            mat-raised-button class="generate-btn" (click)="editCertificateGeneration()">
            <mat-icon style="color: white;" class="mr-2">workspace_premium</mat-icon>
            <span style="color: white;">Generate Certificate</span>
          </button> -->


          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>

        <button type="submit" class="btn btn-primary" [disabled]="remarkForm.invalid">
           {{ statusModal.action === 'approved' ? (isFinalApproval ?  'Final Approve' : 'Approve/Forward') : statusModal.action === 'raise_extra_payment' ? 'Raise Extra Payment' : statusModal.action === 'send_back' ? 'Send Back' : 'Reject'}}
          </button>
        </div>
      </form>
    <!-- </div> -->
  </div>
</div>