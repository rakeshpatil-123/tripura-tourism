<!-- user-application-view.component.html -->
<div class="application-view-container">


  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading application details...</p>
  </div>

  <div class="error-card" *ngIf="error && !isLoading">
    <div class="icon">‚ö†Ô∏è</div>
    <p>{{ error }}</p>
    <button class="btn-primary" (click)="fetchApplicationDetails()">Retry</button>
  </div>

  <div class="application-card" *ngIf="application && !isLoading">
  
    <section class="section">
      <div class="app-header">
        <h2 class="app-title">Application Information</h2>
        <button class="btn-download" (click)="downloadCertificate()">
          Download Certificate
        </button>
      </div>
      <div class="grid">
        <div class="field">
          <label>Application Date</label>
          <span>{{ formatDate(application?.application_date) || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>Due Date</label>
          <span>{{ formatDate(application?.max_processing_date) || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>Current Step</label>
          <span>Step {{ application?.current_step_number || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>Base Fee</label>
          <span>‚Çπ{{ application?.final_fee || '0' }}</span>
        </div>
        <div class="field" *ngIf="hasExtraPayment">
          <label>Extra Payment</label>
          <span>‚Çπ{{ application?.extra_payment }}</span>
        </div>
        <div class="field">
          <label>Total Fee</label>
          <span>‚Çπ{{ application?.total_fee || '0' }}</span>
        </div>
      </div>
    </section>

    <section class="section">
      <h2> Status</h2>
      <div class="status-display">
        <span [ngClass]="getStatusBadgeClass(application?.status || '')">
          {{ (application?.status || '‚Äî') | titlecase }}
        </span>
        <!-- <div class="remarks" *ngIf="application?.remarks">
          <strong>Remarks:</strong> {{ application?.remarks || '‚Äî' }}
        </div> -->
      </div>
    </section>

    <section class="section" *ngIf="application?.application_data_structured?.length">
      <h2> Applicant Information</h2>
      <div class="grid">
        <div class="field" *ngFor="let qa of application.application_data_structured">
          <label>{{ qa.question }}</label>
          <span>{{ formatAnswerForDisplay(qa.answer) }}</span>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="!application?.application_data_structured?.length && application?.application_data">
      <h2> Applicant Information </h2>
      <div class="grid">
        <div class="field" *ngFor="let entry of application.application_data | keyvalue">
          <label>{{ getLabel(entry.key) }}</label>
          <span>{{ entry.value || '‚Äî' }}</span>
        </div>
      </div>
    </section>

    <section class="section">
      <h2> Payment Information</h2>
      <div class="grid">
        <div class="field">
          <label>Payment Status</label>
          <span [ngClass]="{
              'payment-pending': application?.payment_status === 'pending',
              'payment-success': application?.payment_status === 'success',
              'payment-failed': application?.payment_status === 'failed'
            }">
            {{ application?.payment_status ? (application.payment_status | titlecase) : '‚Äî' }}
          </span>
        </div>
        <div class="field" *ngIf="application?.payment_status !== 'pending'">
          <label>Transaction ID</label>
          <span>{{ application?.payment_transId || '‚Äî' }}</span>
        </div>
        <div class="field" *ngIf="application?.payment_status !== 'pending'">
          <label>Payment Time</label>
          <span>{{ formatDate(application?.payment_time) || '‚Äî' }}</span>
        </div>
        <div class="field" *ngIf="application?.GRN_number">
          <label>GRN Number</label>
          <span>{{ application?.GRN_number || '‚Äî' }}</span>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="application?.NOC_letter_number">
      <h2>üìÑ NOC Details</h2>
      <div class="grid">
        <div class="field">
          <label>NOC Letter Number</label>
          <span>{{ application?.NOC_letter_number || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>NOC Letter Date</label>
          <span>{{ formatDate(application?.NOC_letter_date) || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>NOC Expiry Date</label>
          <span>{{ formatDate(application?.NOC_expiry_date) || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>Penalty Amount</label>
          <span *ngIf="application?.NOC_penalty_amount !== null && application?.NOC_penalty_amount !== undefined">
            ‚Çπ{{ application?.NOC_penalty_amount }}
          </span>
          <span *ngIf="application?.NOC_penalty_amount === null || application?.NOC_penalty_amount === undefined">
            ‚Äî
          </span>
        </div>
      </div>
    </section>

<section class="section" *ngIf="application?.history_data?.status_file">
  <h2>Remarks</h2>
  <div class="grid">
    <div class="field">
      <label>Status Document</label>
      <div class="file-display">
        <span>{{ getFileNameFromUrl(application?.history_data?.status_file) }}</span>
        <button 
          type="button" 
          class="btn-view btn-success btn-sm" 
          (click)="previewFile(application?.history_data?.status_file!)">
          View
        </button>
      </div>
    </div>

    <div class="field" *ngIf="application?.history_data?.remarks">
      <label>Remarks</label>
      <span>{{ application?.history_data?.remarks }}</span>
    </div>

    <div class="field">
      <label>Action Taken At</label>
      <span>{{ formatDate(application?.history_data?.action_taken_at) }}</span>
    </div>

    <div class="field">
      <label>Status</label>
      <span [ngClass]="getStatusBadgeClass(application?.history_data?.status || '')">
        {{ (application?.history_data?.status || '') | titlecase }}
      </span>
    </div>
  </div>
</section>
  </div>
</div>