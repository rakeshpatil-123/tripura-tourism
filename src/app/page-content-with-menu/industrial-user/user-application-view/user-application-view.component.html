<!-- user-application-view.component.html -->
<div class="application-view-container">
  <div class="loading" *ngIf="isLoading">
   <app-loader></app-loader>>
  </div>

  <div class="error-card" *ngIf="error && !isLoading">
    <div class="icon">‚ö†Ô∏è</div>
    <p>{{ error }}</p>
    <button class="btn-primary" (click)="fetchApplicationDetails()">Retry</button>
  </div>

  <div class="application-card" *ngIf="application && !isLoading">
    <section class="section">
      <div class="app-header">
        <h2 class="app-title">Application Information</h2>
        <!-- Show Download Certificate button only if not third-party AND has download URL -->
        <button class="btn-download" 
                *ngIf=" hasDownloadUrl" 
                (click)="downloadCertificate()">
          Download Certificate
        </button>
      </div>
      <div class="grid">
        <div class="field" *ngIf="application?.applicationId">
          <label>Application Number</label>
          <span>{{ application?.applicationId || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>Application Date</label>
          <span>{{ formatDate(application?.application_date) || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>Due Date</label>
          <span>{{ formatDate(application?.max_processing_date) || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>Approved Fee</label>
          <span>{{ application?.approved_fee || '‚Çπ0' }}</span>
        </div>
        <div class="field" *ngIf="!isThirdParty">
          <label>Current Step</label>
          <span> {{ historyDetails[0]?.step_number || '‚Äî' }}</span>
        </div>
        <div class="field" *ngIf="!isThirdParty">
          <label>Current Step Name</label>
          <span class="capitalize" > {{ historyDetails[0]?.step_type || '‚Äî' }}</span>
        </div>
        <div class="field" *ngIf="!isThirdParty">
          <label>Base Fee</label>
          <span>‚Çπ{{ application?.final_fee || '‚Çπ0' }}</span>
        </div>
        <div class="field" *ngIf="hasExtraPayment">
          <label>Extra Payment</label>
          <span>‚Çπ{{ application?.extra_payment }}</span>
        </div>
        <div class="field" *ngIf="!isThirdParty">
          <label>Total Fee</label>
          <span>‚Çπ{{ application?.total_fee || '‚Çπ0' }}</span>
        </div>
        <div class="field" *ngIf="serviceName !== '' ">
          <label>Applied For</label>
          <span>{{ serviceName}}</span>
        </div>
      </div>
    </section>

    <section class="section">
      <h2>Status</h2>
      <div class="status-display">
        <span [ngClass]="getStatusBadgeClass(application?.status || '')">
          {{ (application?.status || '‚Äî') | titlecase }}
        </span>
      </div>
    </section>

    <section class="section" 
             *ngIf="!isThirdParty && application?.application_data_structured?.length">
      <h2>Applicant Information</h2>
      <div class="grid">
        <div class="field" *ngFor="let qa of application.application_data_structured">
          @if(!qa.answer.includes('http')) {
          <label>{{ qa.question }}</label>
          <span>{{ formatAnswerForDisplay(qa.answer) }}</span>
          }
          @if(qa.answer.includes('http')) {
          <div class="file-display">
          <label>{{ qa.question }}</label>
            <span>{{ getFileNameFromUrl(qa.answer) }}</span>
            <button type="button" class="btn-view btn-success btn-sm" (click)="previewFile(qa.answer)">
              View
            </button>
          </div>
          }
        </div>
      </div>
    </section>

    <!-- Hide Applicant Information section for third-party -->
    <section class="section" 
             *ngIf="!isThirdParty && !application?.application_data_structured?.length && application?.application_data">
      <h2>Applicant Information</h2>
      <div class="grid">
        <div class="field" *ngFor="let entry of application.application_data | keyvalue">
          <label>{{ getLabel(entry.key) }}</label>
          <span>{{ entry.value || '‚Äî' }}</span>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="application?.payment_status">
      <h2>Payment Information</h2>
      <div class="grid">
        <div class="field">
          <label>Payment Status</label>
          <span [ngClass]="{
              'payment-pending': application?.payment_status === 'pending',
              'payment-success': application?.payment_status === 'success',
              'payment-failed': application?.payment_status === 'failed'
            }">
            {{ application?.payment_status ? (application.payment_status | titlecase) : '‚Äî' }}
          </span>
        </div>
        <div class="field" *ngIf="application?.payment_status !== 'pending'">
          <label>Transaction ID</label>
          <span>{{ application?.payment_transId || '‚Äî' }}</span>
        </div>
        <div class="field" *ngIf="application?.payment_status !== 'pending'">
          <label>Payment Time</label>
          <span>{{ formatDate(application?.payment_time) || '‚Äî' }}</span>
        </div>
        <div class="field" *ngIf="application?.GRN_number">
          <label>GRN Number</label>
          <span>{{ application?.GRN_number || '‚Äî' }}</span>
        </div>
      </div>
    </section>

    <section class="section" *ngIf="application?.NOC_letter_number">
      <h2>üìÑ NOC Details</h2>
      <div class="grid">
        <div class="field">
          <label>NOC Letter Number</label>
          <span>{{ application?.NOC_letter_number || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>NOC Letter Date</label>
          <span>{{ formatDate(application?.NOC_letter_date) || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>NOC Expiry Date</label>
          <span>{{ formatDate(application?.NOC_expiry_date) || '‚Äî' }}</span>
        </div>
        <div class="field">
          <label>Penalty Amount</label>
          <span *ngIf="application?.NOC_penalty_amount !== null && application?.NOC_penalty_amount !== undefined">
            ‚Çπ{{ application?.NOC_penalty_amount }}
          </span>
          <span *ngIf="application?.NOC_penalty_amount === null || application?.NOC_penalty_amount === undefined">
            ‚Äî
          </span>
        </div>
      </div>
    </section>

    
<section class="section" >
  <h2>Application History</h2>
  <app-dynamic-table
    [searchable]="false"
    [columns]="historyColumns"
    [data]="historyDetails">
  </app-dynamic-table>
</section>

    <section class="section">
      <h2>Payment Details</h2>

      <app-dynamic-table [searchable]="false" [columns]="transactionColumns" [data]="transactionDetails"  ></app-dynamic-table>
    </section>
  </div>
</div>