<div class="page-wrapper">
  <!-- Background Video -->
  <video autoplay muted loop playsinline class="bg-video" aria-hidden="true">
    <source src="assets/videos/tripura-tourism-video.mp4" type="video/mp4" />
  </video>
  <div class="bg-overlay" aria-hidden="true"></div>

  <!-- Centered Card -->
  <div class="center-stage">
    <div class="auth-card">
      <div class="card">
        <div class="logo-wrapper">
          <img src="assets/logo/tripuratourismlogo.png" alt="Tripura Tourism Logo" class="logo" />
        </div>

        <h2 class="title">{{ editMode ? 'Edit Registration' : 'User Registration' }}</h2>
        <p class="subtitle">Create your account to continue</p>

        <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()" class="form">

          <!-- NAME -->
          <app-ilogi-input
            fieldId="name"
            fieldLabel="Full Name"
            [mandatory]="true"
            formControlName="name"
            placeholder="Enter your full name">
          </app-ilogi-input>

          <!-- EMAIL -->
          <app-ilogi-input
            fieldId="email_id"
            fieldLabel="Email ID"
            [mandatory]="true"
            formControlName="email_id"
            type="email"
            placeholder="Enter your email">
          </app-ilogi-input>
            <!-- Authorized Person -->
          <app-ilogi-input fieldId="authorized_person_name" fieldLabel="Authorized Person Name" [mandatory]="true"
            formControlName="authorized_person_name" placeholder="Enter full name"></app-ilogi-input>
          <small class="error-text"
            *ngIf="registrationForm.get('authorized_person_name')?.touched && registrationForm.get('authorized_person_name')?.invalid">
            Please enter a valid name.
          </small>
           <app-ilogi-input fieldId="mobile_no" fieldLabel="Mobile Number" [mandatory]="true"
              formControlName="mobile_no" placeholder="Enter mobile number" type="text"></app-ilogi-input>
            <small class="error-text" *ngIf="registrationForm.get('mobile_no')?.touched 
                     && registrationForm.get('mobile_no')?.invalid 
                     && !registrationForm.get('mobile_no')?.hasError('taken')">
              Please enter a valid 10-digit mobile number.
            </small>
            <!-- Inline backend status message for mobile (OTP send / already verified / taken etc.) -->
            <small *ngIf="mobileStatusMessage" [ngClass]="{
              'mobile-status-success': mobileStatusType === 'success',
              'mobile-status-error': mobileStatusType === 'error',
              'mobile-status-info': mobileStatusType === 'info'
            }" class="mobile-status-text" aria-live="polite">
              {{ mobileStatusMessage }}
            </small>
            <div *ngIf="!editMode && sourcePage !== 'departmental-users'
                                     && registrationForm.get('mobile_no')?.value?.toString().trim().length === 10
                                     && registrationForm.get('mobile_no')?.valid
                                     && !hideSendOtp
                                     && mobileStatusType !== 'error'" class="otp-section mb-2">
              <button type="button" class="btn-otp" (click)="sendOtp()"
                [disabled]="otpSent || registrationForm.get('mobile_no')?.invalid || registrationForm.get('mobile_no')?.hasError('taken')">
                {{ otpSent ? 'OTP Sent' : 'Send OTP' }}
              </button>
            </div>

            <div
              *ngIf="registrationForm.get('mobile_no')?.value?.toString().trim().length === 10 && registrationForm.get('mobile_no')?.valid"
              class="box mt-2">
              <input type="checkbox" [checked]="whatsappSameAsMobile" (change)="toggleWhatsappSameAsMobile($event)" />
              <small class="text-sm">Is WhatsApp number same as mobile number?</small>
            </div>
            <!-- OTP Input + Verify Button: additionally hide when hideVerify is true -->
            <div *ngIf="otpSent && !otpVerified && !editMode && sourcePage !== 'departmental-users' && !hideVerify"
              class="otp-section mt-2">
              <app-ilogi-input fieldId="otp" fieldLabel="Enter OTP" [mandatory]="true" [formControl]="otpControl"
                placeholder="Enter 6-digit OTP"></app-ilogi-input>
              <button type="button" class="btn-verify" (click)="verifyOtp()" [disabled]="!otpControl.valid">Verify
                OTP</button>
            </div>

            <!-- Verified message remains visible when otpVerified is true -->
            <!-- <div *ngIf="otpVerified && !editMode && sourcePage !== 'departmental-users'" class="otp-verified mt-1">
            Mobile number verified.
          </div> -->

          <!-- USERNAME -->
          <app-ilogi-input
            fieldId="user_name"
            fieldLabel="Username"
            [mandatory]="true"
            formControlName="user_name"
            placeholder="Choose a username">
          </app-ilogi-input>

          <!-- WHATSAPP -->
          <app-ilogi-input
            *ngIf="!whatsappSameAsMobile"
            fieldId="whatsapp_no"
            fieldLabel="WhatsApp Number"
            [mandatory]="true"
            formControlName="whatsapp_no"
            placeholder="Enter WhatsApp number"
            type="text">
          </app-ilogi-input>

          <!-- ADDRESS -->
          <app-ilogi-input
            fieldId="registered_enterprise_address"
            fieldLabel="Address"
            [mandatory]="true"
            formControlName="registered_enterprise_address"
            placeholder="Enter your address">
          </app-ilogi-input>
          <!-- <ng-container *ngIf="sourcePage !== 'departmental-users'">
            <div class="single-field pan-field">
              <app-ilogi-input fieldId="pan" fieldLabel="PAN Number" [mandatory]="true" formControlName="pan"
                placeholder="Enter PAN (e.g. ABCDE1234F)" type="text">
              </app-ilogi-input>
              <small class="error-text" *ngIf="registrationForm.get('pan')?.touched
                                            && registrationForm.get('pan')?.invalid
                                            && (registrationForm.get('pan')?.value?.toString()?.trim()?.length === 10)
                                            && !registrationForm.get('pan')?.hasError('registered')">
                Please enter a valid PAN number.
              </small>
              <small *ngIf="panStatusMessage" [ngClass]="{
                                    'mobile-status-success': panStatusType === 'success',
                                    'mobile-status-error': panStatusType === 'error',
                                    'mobile-status-info': panStatusType === 'info'
                                  }" class="mobile-status-text pan-status-text" aria-live="polite">
                {{ panStatusMessage }}
              </small>
            </div>
          </ng-container> -->

          <!-- LOCATION -->
          <app-ilogi-select
            fieldId="district_id"
            fieldLabel="District"
            [mandatory]="true"
            formControlName="district_id"
            [selectOptions]="districts">
          </app-ilogi-select>

          <app-ilogi-select
            fieldId="subdivision_id"
            fieldLabel="Subdivision"
            [mandatory]="true"
            formControlName="subdivision_id"
            [selectOptions]="subdivisions">
          </app-ilogi-select>

          <app-ilogi-select
            fieldId="ulb_id"
            fieldLabel="ULB / Block"
            [mandatory]="true"
            formControlName="ulb_id"
            [selectOptions]="ulbs">
          </app-ilogi-select>
            <app-ilogi-select *ngIf="shouldShow('ward') && sourcePage !== 'departmental-users'"
              [multiple]="sourcePage === 'departmental-users'" fieldId="ward_id" fieldLabel="Ward" [mandatory]="true"
              formControlName="ward_id" [selectOptions]="wards" placeholder="Select ward" [disabled]="!ulbs.length || loadingUlbs">
            </app-ilogi-select>


          <!-- PASSWORD -->
          <app-ilogi-input
            fieldId="password"
            fieldLabel="Password"
            [mandatory]="true"
            formControlName="password"
            type="password"
            placeholder="Enter password">
          </app-ilogi-input>

          <app-ilogi-input
            fieldId="confirmPassword"
            fieldLabel="Confirm Password"
            [mandatory]="true"
            formControlName="confirmPassword"
            type="password"
            placeholder="Re-enter password">
          </app-ilogi-input>

          <!-- SUBMIT -->
          <button type="submit" class="btn-submit" [disabled]="!registrationForm.valid">
            {{ editMode ? 'Update' : 'Register' }}
          </button>

          <p class="login-text">
            Already registered?
            <a (click)="goToLogin()">Login</a>
          </p>
        </form>
      </div>
    </div>
  </div>
</div>
