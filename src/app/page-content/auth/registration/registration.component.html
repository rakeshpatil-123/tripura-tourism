<!-- registration.component.html -->
<div class="swgt-container">
  <div class="registration-container">
    <div class="card">
      <h2 class="title">{{ editMode ? 'Edit User Registration' : 'New User Registration' }}</h2>
      <p class="subtitle">Fill in your details to {{ editMode ? 'update' : 'register' }}</p>

      <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()" class="form">
        <div class="enterprise-form">
          <!-- Enterprise Name -->
          <ng-container *ngIf="sourcePage !== 'departmental-users'">
          <app-ilogi-input fieldId="name_of_enterprise" fieldLabel="Name of Enterprise" [mandatory]="true"
            formControlName="name_of_enterprise" placeholder="Enter enterprise name"></app-ilogi-input>
          </ng-container>
          <!-- Authorized Person -->
          <app-ilogi-input fieldId="authorized_person_name" fieldLabel="Authorized Person Name" [mandatory]="true"
            formControlName="authorized_person_name" placeholder="Enter full name"></app-ilogi-input>

          <!-- Email -->
          <app-ilogi-input fieldId="email_id" fieldLabel="Email ID" [mandatory]="true" formControlName="email_id"
            placeholder="Enter email" type="email"></app-ilogi-input>
          <div>
            <!-- Mobile -->
            <app-ilogi-input fieldId="mobile_no" fieldLabel="Mobile Number" [mandatory]="true"
              formControlName="mobile_no" placeholder="Enter mobile number" type="text"></app-ilogi-input>

            <!-- OTP  -->
            <div
              *ngIf="!editMode && sourcePage !== 'departmental-users' && registrationForm.get('mobile_no')?.value?.toString().trim().length >= 10"
              class="otp-section mb-2">
              <button type="button" class="btn-otp" (click)="sendOtp()"
                [disabled]="otpSent || registrationForm.get('mobile_no')?.invalid">
                {{ otpSent ? 'OTP Sent' : 'Send OTP' }}
              </button>
              <!-- <small class="text-muted ml-2"> We’ll send a 6-digit code to verify your number.</small> -->
            </div>

            <!-- OTP Input + Verify Button -->
            <div *ngIf="otpSent && !otpVerified && !editMode && sourcePage !== 'departmental-users'"
              class="otp-section mt-2">
              <app-ilogi-input fieldId="otp" fieldLabel="Enter OTP" [mandatory]="true" [formControl]="otpControl"
                placeholder="Enter 6-digit OTP"></app-ilogi-input>
              <button type="button" class="btn-verify" (click)="verifyOtp()" [disabled]="!otpControl.valid">Verify
                OTP</button>
            </div>

            <div *ngIf="otpVerified && !editMode && sourcePage !== 'departmental-users'" class="otp-verified mt-1">
              ✅ Mobile number verified.
            </div>
          </div>
          <!-- Username -->
          <app-ilogi-input fieldId="user_name" fieldLabel="Username" [mandatory]="true" formControlName="user_name"
            placeholder="Choose a username"></app-ilogi-input>

          <!-- City -->
          <app-ilogi-input *ngIf="!(sourcePage === 'departmental-users')" fieldId="registered_enterprise_city"
            fieldLabel="City" [mandatory]="true" formControlName="registered_enterprise_city"
            placeholder="Enter city"></app-ilogi-input>
        </div>

        <div *ngIf="!(sourcePage === 'departmental-users')" class="single-field">
          <!-- Address -->
          <app-ilogi-input class="height-20" fieldId="registered_enterprise_address"
            fieldLabel="Registered Enterprise Address" [mandatory]="true"
            formControlName="registered_enterprise_address" placeholder="Enter full address"></app-ilogi-input>
        </div>
        <div *ngIf="(sourcePage === 'departmental-users')">
          <app-ilogi-select fieldId="hierarchy_level" fieldLabel="Hierarchy Level" [mandatory]="true"
            formControlName="hierarchy_level" [selectOptions]="hierarchyLevels" placeholder="Select hierarchy level">
          </app-ilogi-select>
          <app-ilogi-radio formControlName="inspector" fieldLabel="Is Inspector">
          </app-ilogi-radio>
          <app-ilogi-select class="mb-10" fieldId="department_id" fieldLabel="Department" [mandatory]="true"
            formControlName="department_id" [selectOptions]="departments" placeholder="Select department">
          </app-ilogi-select>
          <app-ilogi-input fieldId="designation" fieldLabel="Designation" [mandatory]="true"
            formControlName="designation" placeholder="Enter designation">
          </app-ilogi-input>
        </div>
        <!-- District -->
        <app-ilogi-select *ngIf="shouldShow('district')" [multiple]="sourcePage === 'departmental-users'" fieldId="district_id" fieldLabel="District" [mandatory]="true"
          formControlName="district_id" [selectOptions]="districts" placeholder="Select district">
        </app-ilogi-select>

        <!-- Subdivision -->
        <app-ilogi-select *ngIf="shouldShow('subdivision')" [multiple]="sourcePage === 'departmental-users'" fieldId="subdivision_id" fieldLabel="Subdivision"
          [mandatory]="true" formControlName="subdivision_id" [selectOptions]="subdivisions"
          placeholder="Select subdivision" [disabled]="!districts.length || loadingDistricts">
        </app-ilogi-select>

        <!-- ULB -->
        <app-ilogi-select *ngIf="shouldShow('block')" [multiple]="sourcePage === 'departmental-users'" fieldId="ulb_id" fieldLabel="ULB/Block" [mandatory]="true"
          formControlName="ulb_id" [selectOptions]="ulbs" placeholder="Select ULB/Block"
          [disabled]="!subdivisions.length || loadingSubdivisions">
        </app-ilogi-select>

        <!-- Ward -->
        <app-ilogi-select *ngIf="shouldShow('ward')" [multiple]="sourcePage === 'departmental-users'" fieldId="ward_id" fieldLabel="Ward" [mandatory]="true"
          formControlName="ward_id" [selectOptions]="wards" placeholder="Select ward"
          [disabled]="!ulbs.length || loadingUlbs">
        </app-ilogi-select>

        <div class="enterprise-form">
          <!-- Password -->
          <app-ilogi-input fieldId="password" fieldLabel="Password" [mandatory]="true" formControlName="password"
            type="password" placeholder="Enter password"></app-ilogi-input>

          <!-- Confirm Password -->
          <app-ilogi-input fieldId="confirmPassword" fieldLabel="Confirm Password" [mandatory]="true"
            formControlName="confirmPassword" type="password" placeholder="Re-enter password"
            errorMessage="Passwords do not match"></app-ilogi-input>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
          <button type="submit" class="btn-submit btn btn-primary" [disabled]="!registrationForm.valid">
            {{editMode ? 'Update' : 'Register'}}
          </button>
        </div>
      </form>

      <span *ngIf="!(sourcePage === 'departmental-users')" class="text-center small mt-2">Already Registered? <a
          href="/page/login">Login</a></span>
    </div>
  </div>
</div>